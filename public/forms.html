<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Review</title>
</head>
<body>
  <h2>Pending Join Requests</h2>
  <div id="requests">Loading...</div>

  <script>
    async function loadRequests() {
      try {
        const res = await fetch('/requests');
        const data = await res.json();

        if (!Array.isArray(data)) {
          console.error("Unexpected response:", data);
          document.getElementById('requests').innerText = 'Error loading requests.';
          return;
        }

        const container = document.getElementById('requests');
        container.innerHTML = '';
        data.forEach(req => {
          const el = document.createElement('div');
          el.innerHTML =
            "<strong>" + req.username + "</strong><br/>" +
            "Reason: " + req.reason + "<br/>" +
            "<button onclick='approve(" + req.id + ")'>Approve</button> " +
            "<button onclick='deny(" + req.id + ")'>Deny</button><hr/>";
          container.appendChild(el);
        });
      } catch (err) {
        console.error("Request fetch failed:", err);
        document.getElementById('requests').innerText = 'Server error loading requests.';
      }
    }

    async function approve(id) {
      try {
        const res = await fetch('/approve/' + id, { method: 'POST' });
        const data = await res.json();
        if (res.ok) {
          alert("✅ Approved!");
          loadRequests();
        } else {
          alert("❌ Approve failed: " + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert("❌ Approve error: " + err.message);
      }
    }

    async function deny(id) {
      try {
        const res = await fetch('/deny/' + id, { method: 'POST' });
        const data = await res.json();
        if (res.ok) {
          alert("❌ Denied.");
          loadRequests();
        } else {
          alert("❌ Deny failed: " + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert("❌ Deny error: " + err.message);
      }
    }

    loadRequests();
  </script>
</body>
</html>